# 旅游产品智能客服 - 技术架构设计

> **任务**: T2 - 技术架构设计与方案选型  
> **交付物**: `docs/architecture.md` + 架构流程图  
> **负责人**: 析理  
> **日期**: 2026-02-19

---

## 一、LLM 选型对比

| 模型 | 成本(每1K tokens) | 中文能力 | 推理能力 | 推荐场景 |
|-----|------------------|---------|---------|---------|
| **DeepSeek-V3** | $0.002 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 💰 首选，性价比最高 |
| **GPT-4o** | $0.015 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 复杂推理/英文场景 |
| **Claude 3.5 Sonnet** | $0.015 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 长上下文/安全敏感 |
| **Gemini 3 Flash** | $0.001 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 低延迟/高频请求 |

**推荐策略**:
- 主力: DeepSeek-V3 (成本仅为GPT-4o的 13%)
- 备用: Gemini 3 Flash (ZenMux自动降级)
- 复杂场景: GPT-4o (意图识别/情感分析)

---

## 二、RAG 方案设计

### 2.1 向量数据库选型

| 方案 | 特点 | 成本 | 推荐度 |
|-----|------|-----|--------|
| **QMD (本地)** | 隐私好、零成本、无需网络 | ¥0 | ⭐⭐⭐⭐⭐ |
| **Chroma (本地)** | 开源、易部署、社区活跃 | ¥0 | ⭐⭐⭐⭐ |
| **Pinecone** | 托管、高可用、自动扩展 | $0.1/千次查询 | ⭐⭐⭐ |
| **Milvus** | 企业级、分布式、高性能 | 自建成本 | ⭐⭐⭐ |

**推荐**: QMD (已集成OpenClaw) 或 Chroma

### 2.2 知识库架构

```
┌─────────────────────────────────────────────────────────────┐
│                     知识来源层                               │
│  ├─ 产品文档 (PDF/Word/网页)                                 │
│  ├─ 历史对话记录 (CSV/JSON)                                  │
│  ├─ FAQ库 (结构化数据)                                       │
│  └─ 政策文档 (退改/签证/保险)                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     文档处理层 (ETL)                         │
│  ├─ 文本提取 ( unstructured / pdfplumber )                   │
│  ├─ 语义分块 (RecursiveCharacterTextSplitter)                │
│  │     ├─ Chunk大小: 512 tokens                              │
│  │     ├─ 重叠: 50 tokens                                    │
│  │     └─ 按段落/标题智能分割                                │
│  └─ 元数据标注 (产品ID/类别/有效期)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     向量索引层                               │
│  ├─ Embedding模型: BAAI/bge-large-zh-v1.5 (中文优化)         │
│  ├─ 向量维度: 1024                                           │
│  ├─ 相似度算法: Cosine Similarity                            │
│  └─ Top-K检索: 5 (可调)                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、多渠道接入方案

### 3.1 架构概览

```
                    ┌─────────────────┐
                    │   负载均衡器     │
                    │  (Nginx/Cloud)  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ WhatsApp Bot  │   │  微信服务号    │   │   Web Chat    │
│  (Meta API)   │   │ (公众号API)   │   │  (WebSocket)  │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  统一消息网关    │
                    │ Message Router  │
                    │  (标准化格式)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   客服Agent     │
                    │  (OpenClaw)     │
                    │  ├─ 意图识别    │
                    │  ├─ RAG检索     │
                    │  └─ 回复生成    │
                    └─────────────────┘
```

### 3.2 各渠道接入方案

| 渠道 | 技术方案 | 难度 | 成本 |
|-----|---------|-----|------|
| **WhatsApp** | Meta Business API + Webhook | 中 | $0.005/条 |
| **微信** | 服务号 + 服务器配置 + 消息加解密 | 中高 | ¥300/年认证 |
| **网页** | WebSocket + React组件 | 低 | 无 |
| **Telegram** | Bot API | 低 | 无 |

---

## 四、系统架构图

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户交互层                                   │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │WhatsApp │  │  微信   │  │ Web聊天 │  │ Telegram│  │ 小程序  │   │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘   │
│       └─────────────┴─────────────┴─────────────┴─────────────┘      │
│                              │                                       │
└──────────────────────────────┼───────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          接入网关层                                   │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │              Unified Message Gateway                        │    │
│  │  ├─ 消息标准化 (统一格式: user_id, channel, content, ts)    │    │
│  │  ├─ 频率限制 (防刷屏)                                        │    │
│  │  ├─ 会话管理 (上下文保持)                                    │    │
│  │  └─ 多渠道状态同步                                          │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          核心引擎层                                   │
│                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   Intent Class  │    │   RAG Engine    │    │  Response Gen   │ │
│  │   意图识别模块   │───▶│   知识检索引擎   │───▶│   回复生成模块   │ │
│  │                 │    │                 │    │                 │ │
│  │ • 意图分类      │    │ • 向量检索      │    │ • Prompt工程    │ │
│  │ • 实体提取      │    │ • 重排序        │    │ • 多轮对话      │ │
│  │ • 情感分析      │    │ • 上下文融合    │    │ • 安全过滤      │ │
│  │ • 置信度评分    │    │ • 知识时效检查  │    │ • 格式标准化    │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     LLM Router (ZenMux)                     │   │
│  │    DeepSeek-V3 ◄───► Gemini Flash ◄───► GPT-4o Fallback   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          数据存储层                                   │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  向量数据库   │  │   对话记录   │  │   知识库     │              │
│  │   (QMD)      │  │  (SQLite)    │  │  (Markdown)  │              │
│  │              │  │              │  │              │              │
│  │ • 产品向量   │  │ • 消息历史   │  │ • 产品文档   │              │
│  │ • FAQ向量    │  │ • 会话状态   │  │ • 政策文件   │              │
│  │ • 语料向量   │  │ • 用户画像   │  │ • 历史对话   │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          运营管理层                                   │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   管理后台   │  │   人工坐席   │  │   监控告警   │              │
│  │  (Dashboard) │  │  (Handoff)   │  │  (Monitor)   │              │
│  │              │  │              │  │              │              │
│  │ • 知识库管理 │  │ • 实时接管   │  │ • 响应延迟   │              │
│  │ • 对话记录   │  │ • 会话转接   │  │ • 错误率     │              │
│  │ • 数据统计   │  │ • 质量评分   │  │ • 人工介入率 │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 数据流图

```
用户消息
    │
    ▼
┌────────────────────────────────────┐
│ 1. 消息标准化 (统一格式)            │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 2. 意图识别 (Intent + 置信度)       │
│    └─ 紧急? ──▶ 立即转人工          │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 3. 实体提取 (产品/日期/人数等)      │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 4. RAG检索 (向量相似度Top-5)        │
│    ├─ 产品知识                      │
│    ├─ FAQ匹配                       │
│    └─ 政策文档                      │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 5. 上下文融合 (历史对话)            │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 6. LLM生成回复                      │
│    (DeepSeek-V3 via ZenMux)         │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 7. 安全过滤 (敏感词/合规检查)       │
└────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────┐
│ 8. 返回用户 (多渠道适配)            │
└────────────────────────────────────┘
```

---

## 五、技术栈清单

| 层级 | 技术选型 | 用途 |
|-----|---------|------|
| **运行时** | Python 3.11+ | 主开发语言 |
| **框架** | FastAPI | API服务 |
| **LLM调用** | ZenMux / OpenRouter | 模型路由 |
| **向量检索** | QMD / Chroma | 知识库检索 |
| **Embedding** | BAAI/bge-large-zh-v1.5 | 文本向量化 |
| **数据库** | SQLite (轻量) / PostgreSQL (生产) | 数据持久化 |
| **缓存** | Redis | 会话状态/限流 |
| **消息队列** | Celery + RabbitMQ | 异步任务 |
| **部署** | Docker + Docker Compose | 容器化 |
| **监控** | Prometheus + Grafana | 指标监控 |

---

## 六、交付清单

- [x] LLM选型对比与推荐策略
- [x] RAG方案设计 (向量库+知识库架构)
- [x] 多渠道接入方案 (WhatsApp/微信/网页)
- [x] 系统架构图 (整体+数据流)
- [x] 技术栈清单

**下一步**: T3 - 知识库建模与索引策略
